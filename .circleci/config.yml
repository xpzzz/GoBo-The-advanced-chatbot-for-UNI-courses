version: 2
jobs:
  build:
    working_directory: ~/czhx
    docker:
      - image: circleci/node:10.15.1
    steps:
      - checkout
      - run:
          name: Check Branch
          command: 'echo $CIRCLE_BRANCH'
      - run:
          name: Init Yarn
          command: 'yarn install'
          path: ~/czhx/czhx-web
      - run:
          name: Unit Test
          command: 'yarn test'
          path: ~/czhx/czhx-web
      - run:
          name: Build
          command: 'yarn build'
          path: ~/czhx/czhx-web
      - store_artifacts:
          path: ~/czhx/czhx-web/build

  deploy:
    working_directory: ~/czhx
    docker:
      - image: governmentpaas/cf-cli
    steps:
      - checkout
      - run:
          name: Get Artifacts
          command: |
            export CIRCLE_TOKEN='?circle-token='$MY_CI
            curl https://circleci.com/api/v1.1/project/github/$CIRCLE_USERNAME/$CIRCLE_PROJECT_REPONAME/$CIRCLE_PREVIOUS_BUILD_NUM/artifacts$CIRCLE_TOKEN | grep -o 'https://[^"]*' > artifacts.txt
            <artifacts.txt xargs -P4 -I % wget %?circle-token=$MY_CI
      - run:
          name: Check Artifacts
          command: |
            pwd
            find .
      - run:
          name: Push to Pivotal
          command: |
            cf login --skip-ssl-validation -a api.run.pivotal.io -u $CF_USER -p $CF_PASSWORD -o unsw-comp9900-19t1-czhx -s development
            cf push -f manifest-pws.yml
            cf logout

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
                - frontend
      - deploy:
          requires:
            - build
          filters:
            branches:
              only:
                - master
                - frontend